<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Lost & Found - Realtime DB</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loading" class="hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <div id="loginPage" class="full-screen">
        <div class="login-card">
            <h2>LOST & FOUND</h2>
            <p>‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£ ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡∏£‡∏±‡∏Å</p>
            <input type="email" id="loginEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏™‡πà @gmail.com)">
            <button class="btn-login" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="mainPage" class="main-container hidden">
        <div class="header">
            <h1 style="margin:0;">LOST & FOUND</h1>
            <div>
                <span id="userDisplay" style="margin-right:15px;"></span>
                <button onclick="handleLogout()" style="cursor:pointer;">Logout</button>
            </div>
        </div>

        <div class="input-section">
            <input type="text" id="itemName" placeholder="Info (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)">
            <input type="text" id="itemLocation" placeholder="Place (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)">
            <input type="file" id="itemImage" accept="image/*" style="display:none;" onchange="document.getElementById('fileName').innerText = this.files[0].name">
            <button onclick="document.getElementById('itemImage').click()">üì∏ <span id="fileName">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span></button>
            <button class="btn-save" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</th>
                    <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                    <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                </tr>
            </thead>
            <tbody id="displayArea"></tbody>
        </table>
    </div>

    <script>
        // ******************************************************
        // üî¥ ‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å App Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∑‡∏°!)
        const API_URL = "https://script.google.com/macros/s/AKfycbyGa1mwedpYaRpMG3rnAvd4nzCUKfiHqvdKGqbfQtpf7ByqQn1cdw8Zp7CuRD-Eq1f4/exec"; 
        // ******************************************************

        let currentUser = localStorage.getItem('API_USER');

        window.onload = () => {
            if (currentUser) {
                showMainPage();
            } else {
                document.getElementById('loginPage').classList.remove('hidden');
            }
        };

        function showLoading(show) {
            const el = document.getElementById('loading');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userDisplay').innerText = currentUser;
            fetchData(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        }

        // --- 1. Login ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Sheet Users ---
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if(!email) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•");

            showLoading(true);
            
            // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà App Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User
            fetch(API_URL + "?action=getUsers")
            .then(res => res.json())
            .then(users => {
                showLoading(false);
                const validUser = users.find(u => u.email === email);
                
                if (validUser) {
                    currentUser = validUser.email;
                    localStorage.setItem('API_USER', currentUser);
                    showMainPage();
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Sheet 'Users'");
                }
            })
            .catch(err => {
                showLoading(false);
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err);
            });
        }

        function handleLogout() {
            localStorage.removeItem('API_USER');
            location.reload();
        }

        // --- 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet Data ---
        function saveData() {
            const name = document.getElementById('itemName').value;
            const loc = document.getElementById('itemLocation').value;
            const fileInput = document.getElementById('itemImage');

            if(!name || !loc) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            showLoading(true);

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const sendPost = (base64Img) => {
                const payload = {
                    action: 'save',
                    owner: currentUser,
                    name: name,
                    loc: loc,
                    img: base64Img || ""
                };

                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                })
                .then(res => res.text())
                .then(data => {
                    showLoading(false);
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
                    document.getElementById('itemName').value = "";
                    document.getElementById('itemLocation').value = "";
                    fileInput.value = "";
                    document.getElementById('fileName').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ";
                    fetchData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                })
                .catch(err => {
                    showLoading(false);
                    alert("Error: " + err);
                });
            };

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => sendPost(e.target.result);
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                sendPost("");
            }
        }

        // --- 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet Data ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á ---
        function fetchData() {
            showLoading(true);
            fetch(API_URL + "?action=getData")
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                const tbody = document.getElementById('displayArea');
                tbody.innerHTML = "";

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                data.reverse().forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.time}</td>
                            <td>${item.owner}</td>
                            <td>${item.name}</td>
                            <td>${item.loc}</td>
                            <td>${item.img ? `<img src="${item.img}" class="thumb-img">` : '-'}</td>
                            <td><button onclick="deleteItem('${item.id}')" style="color:red;cursor:pointer;">‡∏•‡∏ö</button></td>
                        </tr>
                    `;
                });
            });
        }

        // --- 4. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        function deleteItem(id) {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
            
            showLoading(true);
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete', id: id })
            })
            .then(res => res.text())
            .then(data => {
                fetchData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            });
        }
    </script>
</body>
</html>